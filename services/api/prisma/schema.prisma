// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Town {
  id       String  @id @default(cuid())
  name     String  @unique
  slug     String  @unique
  isActive Boolean @default(true)

  warehouse    Warehouse?
  townProducts TownProduct[]
  orders       Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Warehouse {
  id     String @id @default(cuid())
  townId String @unique
  town   Town   @relation(fields: [townId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PricingModel {
  UNIT
  WEIGHT
}

enum PaymentPurpose {
  UPFRONT_FEES
  COD_GOODS
}

enum PaymentMethod {
  MOMO
  COD
}

enum PaymentStatus {
  PENDING
  INITIATED
  SUCCESS
  FAILED
  CANCELLED
}

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  isActive    Boolean @default(true)

  townProducts TownProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TownProduct {
  id String @id @default(cuid())

  townId String
  town   Town   @relation(fields: [townId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  pricingModel PricingModel @default(UNIT)
  orderItems   OrderItem[]

  // Prices (use one depending on pricingModel)
  pricePerUnit Decimal? @db.Decimal(12, 2)
  pricePerKg   Decimal? @db.Decimal(12, 2)

  // Stock (optional for now; later we can enforce more rules)
  stockQty         Int?
  stockWeightGrams Int?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([townId, productId])
  @@index([townId])
  @@index([productId])
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  PAID
  FULFILLED
  SETTLED
  CANCELLED
}

model Order {
  id String @id @default(cuid())

  townId String
  town   Town   @relation(fields: [townId], references: [id], onDelete: Cascade)

  status OrderStatus @default(DRAFT)

  customerEmail String?
  customerPhone String?
  goodsPaymentMethod PaymentMethod @default(COD)
  deliveryCodeHash      String?
  deliveryCodeExpiresAt DateTime?


  // Existing totals (keep for now)
  subtotal Decimal @default(0.00) @db.Decimal(12, 2)
  total    Decimal @default(0.00) @db.Decimal(12, 2)

  // Split totals for "fees upfront + goods COD"
  itemsSubtotal Decimal @default(0) @db.Decimal(12, 2)
  deliveryFee   Decimal @default(0) @db.Decimal(12, 2)
  serviceFee    Decimal @default(0) @db.Decimal(12, 2)

  payNowTotal        Decimal @default(0) @db.Decimal(12, 2)
  payOnDeliveryTotal Decimal @default(0) @db.Decimal(12, 2)

  items    OrderItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([townId])
  @@index([status])
}

model OrderItem {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  townProductId String
  townProduct   TownProduct @relation(fields: [townProductId], references: [id], onDelete: Cascade)

  // For UNIT items
  quantity Int?

  // For WEIGHT items
  weightGrams Int?

  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([townProductId])
}

model Payment {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  purpose PaymentPurpose
  method  PaymentMethod
  status  PaymentStatus  @default(PENDING)

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("GHS")

  // provider fields (Hubtel etc.)
  provider            String?
  clientReference     String? @unique
  hubtelTransactionId String?
  hubtelResponse      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, purpose])
  @@index([orderId])
  @@index([status])
  @@index([method])
}
